{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Ali/Desktop/Leedshack2026/leedshack2026-prototype/app/api/celestrak/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\r\nimport * as satellite from \"satellite.js\"\r\nimport type { SatellitePosition, DensityBandData } from \"@/lib/orbital\"\r\n\r\n// Cache the fetched data for 10 minutes\r\nlet cache: {\r\n  data: CelestrakResponse | null\r\n  fetchedAt: number\r\n} = { data: null, fetchedAt: 0 }\r\n\r\nconst CACHE_TTL = 10 * 60 * 1000 // 10 minutes\r\n\r\ninterface CelestrakResponse {\r\n  satellites: SatellitePosition[]\r\n  densityBands: DensityBandData[]\r\n  stats: {\r\n    totalTracked: number\r\n    activeSats: number\r\n    debrisObjects: number\r\n    stationObjects: number\r\n    recentLaunches: number\r\n    avgAltitude: number\r\n    peakBand: string\r\n    peakCount: number\r\n  }\r\n  lastUpdated: string\r\n}\r\n\r\n// Fetch the comprehensive TLE index from CelesTrak\r\nasync function fetchTleIndex(): Promise<string> {\r\n  const url = \"https://celestrak.org/NORAD/elements/index.php?FORMAT=tle\"\r\n  const res = await fetch(url, { signal: AbortSignal.timeout(30000) })\r\n  if (!res.ok) throw new Error(\"Failed to fetch TLE index\")\r\n  return res.text()\r\n}\r\n\r\nasync function buildCelestrakData(): Promise<CelestrakResponse> {\r\n  const now = new Date()\r\n\r\n  // Fetch TLE index and parse into TLE triples\r\n  const tleText = await fetchTleIndex()\r\n  const lines = tleText.split(/\\r?\\n/).map((l) => l.trim()).filter(Boolean)\r\n  \r\n  const tles: { name: string; line1: string; line2: string }[] = []\r\n  for (let i = 0; i < lines.length - 2; i++) {\r\n    const a = lines[i]\r\n    const b = lines[i + 1]\r\n    const c = lines[i + 2]\r\n    if (b.startsWith(\"1 \") && c.startsWith(\"2 \")) {\r\n      tles.push({ name: a, line1: b, line2: c })\r\n      i += 2\r\n    }\r\n  }\r\n\r\n  // Parse all TLEs and compute positions\r\n  const satellites: SatellitePosition[] = []\r\n  for (const t of tles) {\r\n    try {\r\n      const satrec = satellite.twoline2satrec(t.line1, t.line2)\r\n      const posVel = satellite.propagate(satrec, now)\r\n      if (!posVel.position || typeof posVel.position === 'boolean') continue\r\n      \r\n      const gmst = satellite.gstime(now)\r\n      const geo = satellite.eciToGeodetic(posVel.position, gmst)\r\n      const lat = (geo.latitude * 180) / Math.PI\r\n      const lon = (geo.longitude * 180) / Math.PI\r\n      const altitudeKm = geo.height\r\n      \r\n      if (!isFinite(lat) || !isFinite(lon) || altitudeKm < 0) continue\r\n\r\n      // Determine type from name\r\n      const lname = (t.name || \"\").toLowerCase()\r\n      let type: SatellitePosition[\"type\"] = \"active\"\r\n      if (lname.includes(\"debris\") || lname.includes(\"deb\")) type = \"debris\"\r\n      else if (lname.includes(\"station\") || lname.includes(\"iss\")) type = \"station\"\r\n\r\n      satellites.push({\r\n        name: t.name,\r\n        noradId: parseInt(t.line1.substring(2, 7).trim(), 10) || 0,\r\n        lat,\r\n        lon,\r\n        altitudeKm,\r\n        inclination: (satrec.inclo || 0) * (180 / Math.PI),\r\n        type,\r\n      })\r\n    } catch {\r\n      // Skip bad TLEs\r\n    }\r\n  }\r\n\r\n  // Compute density bands from satellite altitudes (200-1200 km, 50 km bins)\r\n  const bandSize = 50\r\n  const minAlt = 200\r\n  const maxAlt = 1200\r\n  const bands: DensityBandData[] = []\r\n  for (let start = minAlt; start < maxAlt; start += bandSize) {\r\n    bands.push({ bandStart: start, bandEnd: start + bandSize, objectCount: 0, density: 0 })\r\n  }\r\n\r\n  for (const s of satellites) {\r\n    for (const band of bands) {\r\n      if (s.altitudeKm >= band.bandStart && s.altitudeKm < band.bandEnd) {\r\n        band.objectCount++\r\n        break\r\n      }\r\n    }\r\n  }\r\n\r\n  const maxCount = Math.max(...bands.map((b) => b.objectCount), 1)\r\n  for (const band of bands) band.density = band.objectCount / maxCount\r\n\r\n  const peakBand = bands.length > 0 ? bands.reduce((max, b) => (b.objectCount > max.objectCount ? b : max), bands[0]) : { bandStart: 0, bandEnd: 0, objectCount: 0, density: 0 }\r\n\r\n  const totalTracked = satellites.length\r\n  const activeSats = satellites.filter((s) => s.type === \"active\").length\r\n  const debrisObjects = satellites.filter((s) => s.type === \"debris\").length\r\n  const stationObjects = satellites.filter((s) => s.type === \"station\").length\r\n  const avgAlt = Math.round(satellites.reduce((s, x) => s + (x.altitudeKm || 0), 0) / Math.max(satellites.length, 1))\r\n\r\n  return {\r\n    satellites,\r\n    densityBands: bands,\r\n    stats: {\r\n      totalTracked,\r\n      activeSats,\r\n      debrisObjects,\r\n      stationObjects,\r\n      recentLaunches: 0,\r\n      avgAltitude: avgAlt,\r\n      peakBand: `${peakBand.bandStart}-${peakBand.bandEnd} km`,\r\n      peakCount: peakBand.objectCount,\r\n    },\r\n    lastUpdated: now.toISOString(),\r\n  }\r\n}\r\n\r\nexport async function GET() {\r\n  // Check cache\r\n  if (cache.data && Date.now() - cache.fetchedAt < CACHE_TTL) {\r\n    return NextResponse.json(cache.data)\r\n  }\r\n\r\n  try {\r\n    const data = await buildCelestrakData()\r\n    cache = { data, fetchedAt: Date.now() }\r\n    return NextResponse.json(data)\r\n  } catch (error) {\r\n    // If we have stale cache, use it\r\n    if (cache.data) {\r\n      return NextResponse.json(cache.data)\r\n    }\r\n    return NextResponse.json(\r\n      { error: \"Failed to fetch CelesTrak data\" },\r\n      { status: 502 }\r\n    )\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}